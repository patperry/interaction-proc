coefs <- c(0.0000000000088817661940, 0.0000000000088817799564, 0.0000000000088817916442, 0.0000000000266453528954, -0.0000000000111022325387, 0.0000000000088817928304, 0.0000000000266453566244, -0.0000000000344169132536, 0.0000000000266453565665, -0.0000000000111022301843, 0.0000000000266453556105, -0.0000000000344169127836, -0.2210901856943522925114, 0.3375100551088050515602, 0.6052766458443240571441, -0.1975506378000617957458, 0.1366914113811623088246, -0.9970693404754946698176, 0.3005038361279870340326, -0.4981155399434290531602, 0.4382498590093516499522, -1.6404569325038380611659, -0.2706876577389271676388, 2.9034314899676338939116, -0.7647275647911627727282, -0.1728218863194559140606, 1.2182887696940467581186, -1.5168043996200484269110, 0.8667114403170788072828, -0.6772656244381672907551, 1.8628488442144877090811, 0.6144641700680270046675, 1.0806045434802100668747, -0.8030417303544159501882, -1.2042030426427474676387, 1.9825746766553908884134, -0.0423285140518662103548, -0.1565768811948575756077, -0.6565911887879716246630, 0.4032461113389070317403, -0.1734950652481211663680, 0.1095427001476625278320, 0.7463163195475426281433, 0.9785587035863728688767, 1.1245898735871757700977, 0.3636590896220613933210, -0.7445006050321486545940, 1.6472368225754103754355, -0.1028087576369274142030, -0.0473184441569641789371, 0.7002401710989845096123, -0.6980740211033105158123, 0.6304979139028750179108, -0.6335368524693302250128, 1.5895129649268457949773, 0.5728436768120038768970, 1.5370508698575389150420, -0.5481858755364985569258, -2.2007652101586296922164, 2.0375345075618982448873, 0.0153049283603154881450, -0.5058643329406694588712, -1.4528575688030576085197, 0.2073921643891235566670, -0.8188584446285278595212, 1.7727526975172891443577, -1.0383811390637238680767, 1.0217958303796426111631, -0.2832641090266218020233, 1.1095981057962689408924, 0.5245420686372045393497, -3.0600821453655546733330, -0.4835622059188267041208, 0.2071151910554796249375, -0.3812280768267491959378, 0.7020164122746632706651, 0.5874947491610140737350, 0.6636480379229124926255, -0.4174839136630786873283, 0.0403624540936448408801, -1.0999367063675240530074, 3.0053705559180068362934, 0.9628000285319623374747, -10.8018996790330721324835, -0.1756983316617173607188, -0.7614841855546264914878, -0.9553658593517444508336, 0.3970629043247326239729, 0.2390025267202696701574, 2.1486711488956080629009, -0.5614529422738007147231, 1.3112289840203907864691, -1.0527262774470886874667, 1.6716864879805961585646, 1.6653902237161586352698, -3.7767045819148874485904, 0.6222751016395630108136, -0.3277517540345957769432, -0.3160125097219782519531, 1.1239781056578068696439, -0.0528612715880329153695, 0.8802330190400081688651, -1.0488405534670499630323, -1.1739969031335808491434, -1.6624036450559940281124, -0.5265958547306265336019, 0.7066592284223363051865, -0.6611096301139955944137, 0.2890416244535807255289, 0.1008604640095451254744, -0.9354294635896388543372, 1.9803832186162531048268, -0.9982978000917267502601, 0.2812704395511003707675, -2.2882630970572765960469, -0.7890541631346156270510, -2.1620931057927315066536, 0.9308096056238439608421, 3.0630785500692265799216, -1.4660316751948700986219, 0.2439498654389293252898, 0.7025521188053417409591, 0.2190831703642949490618, 0.0817240796913781958333, -1.0540813619683460089504, -1.5099394469844571453621, 0.3185808508891049828371, 1.1046525510043356810286, 2.4258980528712528190738, -0.4851305219106609722957, -1.6202185588676210059589, 8.7791546297467526471792, 0.0525522730813983013354, 1.6125777485354009233021, 2.4149785005116322089691, -2.3639476554502474314745, 1.3926435951602424978546, -3.8995379997831967067157, 2.5857595307870964163044, -2.2210970965305198987494, 3.2553175028307452798515, -2.0520554154509835775855, -4.0055452637961446171744, 4.4415683509437577924928, -7.1289550263811456431995, 0.6338084717529401945768, 0.4865135639230029895863, 0.2433900507485025621612, -0.1316031985948161453504, 0.1809592977619088605135, 0.1923065999275473392238, 0.1274059171486205677137, 0.1061779043369557723464, 0.0579801110709507044882, 0.0363035311764942705826, 0.1050142549413453224583, 0.3307749686403901323573, 0.0925857840076638738402, 0.3981178618066079089033, 0.4815349805844211794614, 0.3940973652439497265654, 0.5117333302836705177796, 0.4520354925616724139914, 0.3550918251958615767805, 0.3388854611354924495359, 0.2862940948406747510013, -3.9924393926103181051701, 1.2960021526328513452597, -0.2544856379533284029826, 0.3324847586972780044690, 0.2278400823266437114079, 0.3564526625299409556824, 0.0985855493539320448804, 0.2711362210846192666303, 0.1709788985601013444615, 0.1772726699116366766429, -0.1285660383292120956256, 0.2003730090916670258938, 0.1054554570785175976466, 0.0345763193817845773670, 0.1164886652371753122948, 0.0898811647592434592724, 0.1052645782767626381204, 0.1029668244846402569426, 0.1006026174784707821752, 0.1025396008213918380703, -0.1064550853446129541346, 1.1000409396087136304487)
effects <- c(0.0718388340761197952133, -0.1688476905474458333867, 0.7298922687939045639283, 0.3118297015000406902097, 0.3371786233614120775748, -0.0373310841784140409749, -0.2895896333120080989865, -0.2197302322562074694545, -0.1336251582547882676977, -0.0652718808396210020684, 0.2010309574347179106812, -0.1656980525254827807391, 0.3824008779908558142147, 0.0417057420940940559717, -0.3335242498188516480084, -0.1238331508931996144396, 0.0292614273747491410171, 0.1015956720098927512641, -0.4550692493091138546291, -0.1573103457302504060156, 0.3592757432655754312734, -0.1471548706910719983565, 0.3567303916250081918804, -0.0890349687459093402930, -0.1483932562317613612635, 0.3464122266327450683221, 1.2145421143075041392478, -0.5605622680374547917026, 0.0149524173399093081305, 0.1349729079248569996174, -0.5273547311705877316257, -8.8921776915923818052079, -0.3299868169344590818071, -0.4977356659981136410842, 0.8236160318053350470890, 0.3427142271189864142222, -9.6316563569836048941397, 1.2400252881487454637011, 0.2079484064625632955270, 0.1331812406655774050357, 0.2178243473500823534916, 0.4069084663500019405369, 0.0271159253925042538491, 0.0189334237041276949587, -0.1478793962131683681349, -0.4020371693072913310552, 0.4476095920496286351131, 0.1322284070987998494395, 0.3086377545209222361677, 0.3695169872101466412850, 0.0908132116550231099916, -0.9182489392631383307020, 0.4915429523516440801778, -0.5871366776839680445832, 0.5921910113479562642880, -0.2354650937851961722824, 0.0785413306417752227206, 0.0540340594142994998239, 0.0047835713364267791470, -0.7509619785078861520233, 0.4339154535951231239643, -0.1716044560928995377225, 0.0353589872357819509641, 0.2345067291191195724132, 0.5033603602947488431241, 0.1190008201573624913028, 0.0449141362462797538724, 0.0622474535901727174525, 0.5152551513455053688872, -0.4081150010299277042236, 0.1167633995494591486741, 0.1432963851357562934385, 0.7510751284983626652192, 0.3050997789790422243250, 0.1674586627016231010767, 0.3487872962410938915134, -0.4143367807026617222199, 0.0031088482573793977358, 0.1127499292122377955172, -0.0105664062360556754161, 0.2925593950568475820617, -0.0906465495778704666296, -0.0566751598744117610074, -0.1025655186147756414705, 0.1607561093963369436288, 0.0737293528468018349864, 0.0385185428528721784946, -0.0996060184870437015370, -0.3076243656877179488696, -0.2481797350297627047233, 0.1888963370693690357882, 0.1161715123167967045337, 0.5130710286162586397651, -0.5686117614829699906664, -0.2786250356848576359425, -0.0798762090012659770055, -0.3729746062817840823733, 0.1570142314871603439475, 0.1621515707560857721958, 0.5750906622124486444747, 0.1353947270477174613657, 0.6888676882692285063925, 0.2683046103771161705609, -0.1707160981455446979727, 0.5753424516672487332158, 0.4884557302435600378843, 0.1429862281251644551272, 0.0262324619959052734997, 0.0892736514958692717325, 0.9007908820083893042252, -0.1450683800730941663826, 1.4555919714491618588426, -0.2551437622061921706162, 0.0781159555856657666917, 0.1492262937461669158878, -0.0850660183116117019075, -0.3910087018742177678021, 1.3654214365763310823354, 0.4949030554825182282030, 0.1592727292348754264406, 0.1825749406124363982684, 0.2908308042282528038669, 0.0574442569472297381861, -0.3160091456221097994117, 0.2277820509366855483702, 0.5060137619629636596130, 0.1754846657711268131941, 0.3829565048872975996375, 1.0511486833973657795127, -0.0004115812753848835186, 0.2246783692381324748499, 0.5123290469654497858443, -0.2753353599180095589993, -0.0036529572424315922413, -0.1400257314172256017937, -0.2342999224357240339867, 1.1600831132138500478845, 0.2623191376653855044765, -1.2899079894634046805635, 0.0292275204842555105800, 0.2217666398097688784663, 0.3524690667070632388302, 0.2182257549741900004570, 0.1143351116981529413952, 0.3195713314361906531857, -0.2498645711143613057370, 0.4231729123401831715867, 0.1470925986297726140162, 0.1548426802107902011674, 0.2432007396510997010441, 0.5621626447664496151191, 0.7143021118570831440309, 0.4010813108070399590765, 0.2673108605389640235472, -0.1716578454847111911974, -0.0634372613124936091111)
intervals <- c(60 * 60 * 0.0078125 ,60 * 60 * 0.015625, 60 * 60 * 0.03125, 60 * 60 * 0.0625, 60 * 60 * 0.125, 60 * 60 * 0.25, 60 * 60 * 0.5, 60 * 60 * 1, 60 * 60 * 2, 60 * 60 * 4, 60 * 60 * 8, 60 * 60 * 16, 60 * 60 * 32, 60 * 60 * 64, 60 * 60 * 128, 60 * 60 * 256, 60 * 60 * 512, 60 * 60 * 1024, 60 * 60 * 2048, 60 * 60 * 4096, 60 * 60 * 8192, 60 * 60 * 16384)
intervals.send <- intervals
intervals.recv <- intervals

coefs.static <- matrix(coefs[1:144], 12, 12)
coefs.dynamic <- coefs[-(1:144)]
coefs.dyn.send <- coefs.dynamic[seq_len(length(send.intervals))]
coefs.dyn.recv <- coefs.dynamic[-seq_len(length(send.intervals))]



kGender <- c("Female", "Male")
kSeniority <- c("Junior", "Senior")
kDepartment <- c("Legal", "Trading", "Other")


GetActorVars <- function(gen = kGender,
                         sen = kSeniority,
                         dep = kDepartment)
{
    gen <- lapply(gen, match.arg, kGender)
    sen <- lapply(sen, match.arg, kSeniority)
    dep <- lapply(dep, match.arg, kDepartment)
    
    genF <- "Female" %in% gen
    senJ <- "Junior" %in% sen
    depL <- "Legal" %in% dep
    depT <- "Trading" %in% dep
    
    vars <- c(1, genF, senJ, depL, depT, genF * senJ, genF * depL,
              genF * depT, senJ * depL, senJ * depT, genF * senJ * depL,
              genF * senJ * depT)
    vars
}

GetGenderTable <- function(send.sen = kSeniority,
                           send.dep = kDepartment,
                           recv.sen = kSeniority,
                           recv.dep = kDepartment)
{
    sf <- GetActorVars("Female", send.sen, send.dep)
    sm <- GetActorVars("Male", send.sen, send.dep)
    rf <- GetActorVars("Female", recv.sen, recv.dep)
    rm <- GetActorVars("Male", recv.sen, recv.dep)
    
    ff <- t(sf) %*% coefs.static %*% rf
    mf <- t(sm) %*% coefs.static %*% rf
    fm <- t(sf) %*% coefs.static %*% rm
    mm <- t(sm) %*% coefs.static %*% rm
    
    res <- matrix(c(ff, mf, fm, mm), 2, 2)
    dimnames(res) <- list(kGender, kGender)
    res
}

GetGenderLogOddsRatio <- function(...)
{
    table <- GetGenderTable(...)
    table[1,1] + table[2,2] - (table[1,2] + table[2,1])
}

log.odds <- c()

for (rd in kDepartment) {
    for (rs in kSeniority) {
        for (sd in kDepartment) {    
            for (ss in kSeniority) {
                log.odds <- c(log.odds, GetGenderLogOddsRatio(ss, sd, rs, rd))
            }
        }
    }
}

log.odds <- matrix(log.odds, 6, 6)
names <- kronecker(kDepartment, kSeniority, paste)
dimnames(log.odds) <- list(names, names)

par(mfrow=c(1,1))

pdf("followup.pdf", 6, 6)
plot(c(intervals.send, Inf),
     exp(sum(coefs.dyn.send) - c(0, cumsum(coefs.dyn.send))),
     col = rgb(180, 44, 113, max=255),
     t = "b",
     log ="xy",
     main = "Follow-up Effect",
     xlab = "Time Since Last Send",
     ylab = "Relative Send Probability",
     axes = FALSE)
axis(1, at=c(60, 60 * 30, 60 * 60 * 15, 24 * 3600 * 18.75,  24 * 3600 * 18.75 * 30),
    labels=c("1min", "30min", "15hr", "18.75dy", "1.54yr"))
axis(2)
axis(3, at=c(60, 60 * 30, 60 * 60 * 15, 24 * 3600 * 18.75,  24 * 3600 * 18.75 * 30),
    labels = FALSE)
axis(4, labels=FALSE)
box()
dev.off()

pdf("reciprocation.pdf", 6, 6)
plot(c(intervals.recv, Inf),
     exp(sum(coefs.dyn.recv) - c(0, cumsum(coefs.dyn.recv))),
     col = rgb(180, 44, 113, max=255),
     t = "b",
     log ="xy",
      main = "Reciprocation Effect",
     xlab = "Time Since Last Receive",
     ylab = "Relative Send Probability",
     axes = FALSE)
axis(1, at=c(60, 60 * 30, 60 * 60 * 15, 24 * 3600 * 18.75,  24 * 3600 * 18.75 * 30),
    labels=c("1min", "30min", "15hr", "18.75dy", "1.54yr"))
axis(2)
axis(3, at=c(60, 60 * 30, 60 * 60 * 15, 24 * 3600 * 18.75,  24 * 3600 * 18.75 * 30),
    labels = FALSE)
axis(4, labels=FALSE)
box()
dev.off()
